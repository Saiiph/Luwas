{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Incident Report</title>
    <!-- Link to External CSS File -->
    <link rel="stylesheet" href="{% static 'incident.css' %}">
</head>
<body>

<!-- Header Section -->
<header class="header">
    <div class="header-left">
        <h1><a href="{% url 'home' %}" class="back-link">Luwas</a></h1>
    </div>
    <div class="header-right">
        <button class="header-btn"><a href="{% url 'login' %}" class="back-link">Login</a></button>
        <button class="header-btn"><a href="{% url 'signup' %}" class="back-link">Sign Up</a></button>
    </div>
</header>

<div class="form-container">
    <h1>Create Incident Report</h1>
    <form method="post">
        {% csrf_token %}
        
        <!-- Incident Type Field -->
        <div class="form-group">
            <label for="{{ form.incident_type.id_for_label }}">Incident Type</label>
            {{ form.incident_type }}
            {% if form.incident_type.errors %}
                <div class="error-message">
                    {% for error in form.incident_type.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Severity Field -->
        <div class="form-group">
            <label for="{{ form.severity.id_for_label }}">Severity</label>
            {{ form.severity }}
            {% if form.severity.errors %}
                <div class="error-message">
                    {% for error in form.severity.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Category Field -->
        <div class="form-group">
            <label for="{{ form.category.id_for_label }}">Category</label>
            {{ form.category }}
            {% if form.category.errors %}
                <div class="error-message">
                    {% for error in form.category.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Location Field -->
        <div class="form-group">
            <label for="{{ form.location.id_for_label }}">Location</label>
            <input type="text" name="location" id="location" class="form-control" readonly>
        </div>

        <!-- Latitude Field (Hidden) -->
        <div class="form-group">
            <label for="{{ form.latitude.id_for_label }}">Latitude</label>
            <input type="text" name="latitude" id="latitude" class="form-control" readonly>
        </div>

        <!-- Longitude Field (Hidden) -->
        <div class="form-group">
            <label for="{{ form.longitude.id_for_label }}">Longitude</label>
            <input type="text" name="longitude" id="longitude" class="form-control" readonly>
        </div>

        <!-- Submit Button -->
        <button type="submit"><b>Submit Report</b></button>
    </form>

</div>

<!-- JavaScript to get GPS location and update location field -->
<script>
    // Function to get user's geolocation using HTML5 Geolocation API
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                // Extract latitude and longitude from the position
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;

                // Set the values of the hidden input fields for latitude and longitude
                document.getElementById('latitude').value = latitude;
                document.getElementById('longitude').value = longitude;

                // Call the OpenCage API to get the location name
                getLocationFromCoordinates(latitude, longitude);
            }, function(error) {
                // Handle errors (e.g., permission denied)
                alert("Error: Unable to retrieve your location.");
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // Function to fetch location name using OpenCage API
    function getLocationFromCoordinates(latitude, longitude) {
        var apiKey = '0addd8efb8194cebb0d715a1cb3d980d'; // Replace with your OpenCage API key
        var url = `https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.status.code === 200 && data.results.length > 0) {
                    // Get the formatted address from the API response
                    var location = data.results[0].formatted;
                    document.getElementById('location').value = location;
                } else {
                    document.getElementById('location').value = 'Location not found';
                }
            })
            .catch(error => {
                console.error('Error fetching location:', error);
                document.getElementById('location').value = 'Error fetching location';
            });
    }

    // Call the getLocation function when the page is loaded
    window.onload = function() {
        getLocation();
    };
</script>


</body>
</html>
